
目的是主要分析在runtime中关联对象操作是如何实现的，数据对象时如何保存的。

###1、代码举例
给一个已知的User类添加分类，添加一个`name`属性并关联

```
	#import "User.h"
	
	@interface User (Add)
	@property(nonatomic,copy)NSString * name;
	@end

	@implementation User (Add)
	-(void)setName:(NSString *)name
	{
	    objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
	}
	
	-(NSString *)name
	{
	  return   objc_getAssociatedObject(self, @selector(name));
	}
	@end

```

查看runtime编译后的c++代码 ： 打开相应的文件路终端径运行`clang -rewrite-objc User+Add.m`得到一c++文件，去除一些头文件的引入和很多不知道干嘛用的结构体定义，简易代码如下:

```

	// @interface User (Add)
	// @property(nonatomic,retain)NSString * name;
	/* @end */
	
	typedef struct objc_method *Method;
	typedef struct objc_ivar *Ivar;
	typedef struct objc_category *Category;
	typedef struct objc_property *objc_property_t;
	typedef struct {
	    const char *name;
	    const char *value;
	} objc_property_attribute_t;
	
	
	// @implementation User (Add)
	static void _I_User_Add_setName_(User * self, SEL _cmd, NSString *name) {
	    objc_setAssociatedObject(self, sel_registerName("name"), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
	}
	
	static NSString * _I_User_Add_name(User * self, SEL _cmd) {
	  return objc_getAssociatedObject(self, sel_registerName("name"));
	}
	
	// @end
	

```
以上看出runtime主要通过`objc_setAssociatedObject`进行对象关联处理的。

###2、runtime代码分析
我下载使用的[objc4-680.tar.gz](https://opensource.apple.com/tarballs/objc4/),打开工程编译报错缺少一些文件，不过不影响代码阅读。在`runtime.h`中找到了方法 `objc_setAssociatedObject`依次调用

* `objc_setAssociatedObject_non_gc(object, key, value, policy);`
* `_object_set_associative_reference(object, (void *)key, value, policy);`
在`_object_set_associative_reference`中 实现了关联操作。其代码如下

```
	void _object_set_associative_reference(id object, void *key, id value, uintptr_t policy) {
	    // retain the new value (if any) outside the lock.
	    ObjcAssociation old_association(0, nil);
	    id new_value = value ? acquireValue(value, policy) : nil;
	    {
	        AssociationsManager manager;
	        AssociationsHashMap &associations(manager.associations());
	        disguised_ptr_t disguised_object = DISGUISE(object);
	        if (new_value) {
	            // break any existing association.
	            AssociationsHashMap::iterator i = associations.find(disguised_object);
	            if (i != associations.end()) {
	                // secondary table exists
	                ObjectAssociationMap *refs = i->second;
	                ObjectAssociationMap::iterator j = refs->find(key);
	                if (j != refs->end()) {
	                    old_association = j->second;
	                    j->second = ObjcAssociation(policy, new_value);
	                } else {
	                    (*refs)[key] = ObjcAssociation(policy, new_value);
	                }
	            } else {
	                // create the new association (first time).
	                ObjectAssociationMap *refs = new ObjectAssociationMap;
	                associations[disguised_object] = refs;
	                (*refs)[key] = ObjcAssociation(policy, new_value);
	                object->setHasAssociatedObjects();
	            }
	        } else {
	            // setting the association to nil breaks the association.
	            AssociationsHashMap::iterator i = associations.find(disguised_object);
	            if (i !=  associations.end()) {
	                ObjectAssociationMap *refs = i->second;
	                ObjectAssociationMap::iterator j = refs->find(key);
	                if (j != refs->end()) {
	                    old_association = j->second;
	                    refs->erase(j);
	                }
	            }
	        }
	    }
	    // release the old value (outside of the lock).
	    if (old_association.hasValue()) ReleaseValue()(old_association);
	}

```
我第一次看到以上代码直接蒙圈，都是一些c++的语法，不知道具体都是干啥的。静下来一行一行的仔细看可以推测出其大概处理流程。关联的对象保存在一个hash表中，只是这个hash表有点深，大表套小表，表中还有表一层一层的相关联。可以描述为：一个系统级别的主表1->表2->表3->封装后的属性和要关联的value。

大致流程如下图：

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="processonSvg1000" viewBox="225.0 61.0 975.0 967.0" width="975.0" height="967.0"><defs id="ProcessOnDefs1001"><marker id="ProcessOnMarker1048" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1049" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1061" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1062" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1090" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1091" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1094" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1095" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1102" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1103" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1106" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1107" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1110" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1111" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1126" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1127" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1130" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1131" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1140" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1141" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1144" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1145" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1153" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1154" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1162" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1163" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker></defs><g id="ProcessOnG1002"><path id="ProcessOnPath1003" d="M225.0 61.0H1200.0V1028.0H225.0V61.0Z" fill="none"/><g id="ProcessOnG1004"><g id="ProcessOnG1005" transform="matrix(1.0,0.0,0.0,1.0,245.0,81.0)" opacity="1.0"><path id="ProcessOnPath1006" d="M0.0 0.0L250.0 0.0L250.0 105.0L0.0 105.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><path id="ProcessOnPath1007" d="M0.0 0.0L250.0 0.0L250.0 40.0L0.0 40.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1008" transform="matrix(1.0,0.0,0.0,1.0,10.0,10.0)"><text id="ProcessOnText1009" fill="#000000" font-weight="bold" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="16" x="115.0" y="16.4">AssociationsManager</text></g></g><g id="ProcessOnG1010" transform="matrix(1.0,0.0,0.0,1.0,245.0,121.0)" opacity="1.0"><path id="ProcessOnPath1011" d="M0.0 0.0L250.0 0.0L250.0 65.0L0.0 65.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1012" transform="matrix(1.0,0.0,0.0,1.0,10.0,15.0)"><text id="ProcessOnText1013" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="14.350000000000001">spinlock_t</text><text id="ProcessOnText1014" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="31.85">AssociationsHashMap</text></g></g><g id="ProcessOnG1015" transform="matrix(1.0,0.0,0.0,1.0,245.0,223.0)" opacity="1.0"><path id="ProcessOnPath1016" d="M0.0 0.0L250.0 0.0L250.0 105.0L0.0 105.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><path id="ProcessOnPath1017" d="M0.0 0.0L250.0 0.0L250.0 40.0L0.0 40.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1018" transform="matrix(1.0,0.0,0.0,1.0,10.0,0.0)"><text id="ProcessOnText1019" fill="#000000" font-weight="bold" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="16" x="115.0" y="16.4">AssociationsHashMap（表1</text><text id="ProcessOnText1020" fill="#000000" font-weight="bold" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="16" x="115.0" y="36.4">）</text></g></g><g id="ProcessOnG1021" transform="matrix(1.0,0.0,0.0,1.0,245.0,263.0)" opacity="1.0"><path id="ProcessOnPath1022" d="M0.0 0.0L250.0 0.0L250.0 65.0L0.0 65.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1023" transform="matrix(1.0,0.0,0.0,1.0,10.0,15.0)"><text id="ProcessOnText1024" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="14.350000000000001">对象地址</text><text id="ProcessOnText1025" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="31.85">AssociationsHashMap</text></g></g><g id="ProcessOnG1026" transform="matrix(1.0,0.0,0.0,1.0,250.0,655.0)" opacity="1.0"><path id="ProcessOnPath1027" d="M0.0 0.0L250.0 0.0L250.0 105.0L0.0 105.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><path id="ProcessOnPath1028" d="M0.0 0.0L250.0 0.0L250.0 40.0L0.0 40.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1029" transform="matrix(1.0,0.0,0.0,1.0,10.0,10.0)"><text id="ProcessOnText1030" fill="#000000" font-weight="bold" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="16" x="115.0" y="16.4">ObjectAssociationMap</text></g></g><g id="ProcessOnG1031" transform="matrix(1.0,0.0,0.0,1.0,250.0,695.0)" opacity="1.0"><path id="ProcessOnPath1032" d="M0.0 0.0L250.0 0.0L250.0 65.0L0.0 65.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1033" transform="matrix(1.0,0.0,0.0,1.0,10.0,15.0)"><text id="ProcessOnText1034" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="14.350000000000001">ke'y</text><text id="ProcessOnText1035" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="31.85">AssociationsHashMap</text></g></g><g id="ProcessOnG1036" transform="matrix(1.0,0.0,0.0,1.0,255.0,898.0)" opacity="1.0"><path id="ProcessOnPath1037" d="M0.0 0.0L250.0 0.0L250.0 105.0L0.0 105.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="none"/><path id="ProcessOnPath1038" d="M0.0 0.0L250.0 0.0L250.0 40.0L0.0 40.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1039" transform="matrix(1.0,0.0,0.0,1.0,10.0,10.0)"><text id="ProcessOnText1040" fill="#000000" font-weight="bold" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="16" x="115.0" y="16.4">ObjcAssociation</text></g></g><g id="ProcessOnG1041" transform="matrix(1.0,0.0,0.0,1.0,255.0,938.0)" opacity="1.0"><path id="ProcessOnPath1042" d="M0.0 0.0L250.0 0.0L250.0 65.0L0.0 65.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1043" transform="matrix(1.0,0.0,0.0,1.0,10.0,15.0)"><text id="ProcessOnText1044" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="14.350000000000001">policy</text><text id="ProcessOnText1045" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="31.85">value</text></g></g><g id="ProcessOnG1046"><path id="ProcessOnPath1047" d="M370.0 186.0L370.0 201.0L370.0 201.0L370.0 202.0" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1048)"/></g><g id="ProcessOnG1050" transform="matrix(1.0,0.0,0.0,1.0,301.5,547.0)" opacity="1.0"><path id="ProcessOnPath1051" d="M0.0 21.0L68.5 0.0L137.0 21.0L68.5 42.0L0.0 21.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1052" transform="matrix(1.0,0.0,0.0,1.0,10.0,12.875)"><text id="ProcessOnText1053" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="58.5" y="13.325">找到？</text></g></g><g id="ProcessOnG1054" transform="matrix(1.0,0.0,0.0,1.0,245.0,453.0)" opacity="1.0"><path id="ProcessOnPath1055" d="M0.0 0.0L250.0 0.0L250.0 65.0L0.0 65.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1056" transform="matrix(1.0,0.0,0.0,1.0,10.0,15.0)"><text id="ProcessOnText1057" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="14.350000000000001">根据对象地址查找对应的</text><text id="ProcessOnText1058" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="14" x="115.0" y="31.85">AssociationsHashMap</text></g></g><g id="ProcessOnG1059"><path id="ProcessOnPath1060" d="M370.0 589.0L370.0 622.0L370.0 622.0L370.0 639.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1061)"/></g><g id="ProcessOnG1063" transform="matrix(1.0,0.0,0.0,1.0,297.0,619.0)" opacity="1.0"><path id="ProcessOnPath1064" d="M0.0 0.0L40.0 0.0L40.0 33.0L0.0 33.0Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1065" transform="matrix(1.0,0.0,0.0,1.0,0.0,8.375)"><text id="ProcessOnText1066" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="20.0" y="13.325">是</text></g></g><g id="ProcessOnG1067" transform="matrix(1.0,0.0,0.0,1.0,516.0,529.5)" opacity="1.0"><path id="ProcessOnPath1068" d="M0.0 0.0L49.0 0.0L49.0 48.0L0.0 48.0Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1069" transform="matrix(1.0,0.0,0.0,1.0,0.0,15.875)"><text id="ProcessOnText1070" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="24.5" y="13.325">否</text></g></g><g id="ProcessOnG1071" transform="matrix(1.0,0.0,0.0,1.0,606.0,943.0)" opacity="1.0"><path id="ProcessOnPath1072" d="M0.0 0.0L345.0 0.0L345.0 65.0L0.0 65.0Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1073" transform="matrix(1.0,0.0,0.0,1.0,0.0,8.125)"><text id="ProcessOnText1074" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="13.325">如果找到说明被关联过，这次可能重新赋值操作。根据传入</text><text id="ProcessOnText1075" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="29.575">的（policy、value）创建ObjcAssociation对象替换旧值。</text><text id="ProcessOnText1076" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="45.825"></text></g></g><g id="ProcessOnG1077" transform="matrix(1.0,0.0,0.0,1.0,608.5,639.0)" opacity="1.0"><path id="ProcessOnPath1078" d="M0.0 0.0L340.0 0.0L340.0 129.0L0.0 129.0Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1079" transform="matrix(1.0,0.0,0.0,1.0,0.0,32.0)"><text id="ProcessOnText1080" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="13.325">走到这一步说明被关联的对象已经被关联过，此map种存放</text><text id="ProcessOnText1081" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="29.575">的所有key-value（ObjcAssociation）都属于这个对象本身</text><text id="ProcessOnText1082" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="45.825">的（可以直接理解为这个类有过其他关联的操作），然后在</text><text id="ProcessOnText1083" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="62.075">根据key遍历map,查找是否有此key关联的对象。</text></g></g><g id="ProcessOnG1084" transform="matrix(1.0,0.0,0.0,1.0,305.0,809.25)" opacity="1.0"><path id="ProcessOnPath1085" d="M0.0 20.75L70.0 0.0L140.0 20.75L70.0 41.5L0.0 20.75Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1086" transform="matrix(1.0,0.0,0.0,1.0,10.0,12.625)"><text id="ProcessOnText1087" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="60.0" y="13.325">找到？</text></g></g><g id="ProcessOnG1088"><path id="ProcessOnPath1089" d="M375.0 760.0L375.0 784.625L375.0 784.625L375.0 794.0139320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1090)"/></g><g id="ProcessOnG1092"><path id="ProcessOnPath1093" d="M375.0 850.75L375.0 872.875L375.0 872.875L375.0 879.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1094)"/></g><g id="ProcessOnG1096" transform="matrix(1.0,0.0,0.0,1.0,278.5,364.0)" opacity="1.0"><path id="ProcessOnPath1097" d="M0.0 24.5L91.5 0.0L183.0 24.5L91.5 49.0L0.0 24.5Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1098" transform="matrix(1.0,0.0,0.0,1.0,10.0,16.375)"><text id="ProcessOnText1099" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="81.5" y="13.325">传入的value==nil？</text></g></g><g id="ProcessOnG1100"><path id="ProcessOnPath1101" d="M370.0 328.0L370.0 346.0L370.0 346.0L370.0 348.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1102)"/></g><g id="ProcessOnG1104"><path id="ProcessOnPath1105" d="M370.0 413.0L370.0 433.0L370.0 433.0L370.0 437.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1106)"/></g><g id="ProcessOnG1108"><path id="ProcessOnPath1109" d="M370.0 518.0L370.0 532.5L370.0 532.5L370.0 533.5" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1110)"/></g><g id="ProcessOnG1112" transform="matrix(1.0,0.0,0.0,1.0,526.0,788.5)" opacity="1.0"><path id="ProcessOnPath1113" d="M0.0 0.0L49.0 0.0L49.0 48.0L0.0 48.0Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1114" transform="matrix(1.0,0.0,0.0,1.0,0.0,15.875)"><text id="ProcessOnText1115" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="24.5" y="13.325">否</text></g></g><g id="ProcessOnG1116" transform="matrix(1.0,0.0,0.0,1.0,606.0,506.5)" opacity="1.0"><path id="ProcessOnPath1117" d="M0.0 0.0L369.0 0.0L369.0 123.0L0.0 123.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1118" transform="matrix(1.0,0.0,0.0,1.0,10.0,20.875)"><text id="ProcessOnText1119" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="13.325">1、根据传入的（policy、value）创建ObjcAssociation对象</text><text id="ProcessOnText1120" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="29.575">2、创建ObjectAssociationMap对象，以传入的key作为key,</text><text id="ProcessOnText1121" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="45.825">1生成的对象为value放入此hash表中。</text><text id="ProcessOnText1122" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="62.075">3、以传入的object地址为key,2中的map对象为value放入As</text><text id="ProcessOnText1123" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="78.325">sociationsHashMap中</text></g></g><g id="ProcessOnG1124"><path id="ProcessOnPath1125" d="M438.5 568.0L522.25 568.0L522.25 568.0L590.7639320225002 568.0" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1126)"/></g><g id="ProcessOnG1128"><path id="ProcessOnPath1129" d="M502.0 701.0L552.0 701.0L552.0 701.0L586.7639320225002 701.0" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1130)"/></g><g id="ProcessOnG1132" transform="matrix(1.0,0.0,0.0,1.0,606.0,788.5)" opacity="1.0"><path id="ProcessOnPath1133" d="M0.0 0.0L363.0 0.0L363.0 83.0L0.0 83.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1134" transform="matrix(1.0,0.0,0.0,1.0,10.0,17.125)"><text id="ProcessOnText1135" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="13.325">未找打此key对应的value，说明这个key不存在，这是增加</text><text id="ProcessOnText1136" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="29.575">的值，根据传入的（policy、value）创建ObjcAssociation</text><text id="ProcessOnText1137" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="45.825">对象，以key为key放入ObjectAssociationMap中。</text></g></g><g id="ProcessOnG1138"><path id="ProcessOnPath1139" d="M445.0 830.0L525.5 830.0L525.5 830.0L590.7639320225002 830.0" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1140)"/></g><g id="ProcessOnG1142"><path id="ProcessOnPath1143" d="M505.0 970.5L551.5 970.5L551.5 970.5L582.7639320225002 970.5" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1144)"/></g><g id="ProcessOnG1146" transform="matrix(1.0,0.0,0.0,1.0,608.5,349.0)" opacity="1.0"><path id="ProcessOnPath1147" d="M0.0 0.0L345.0 0.0L345.0 65.0L0.0 65.0Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1148" transform="matrix(1.0,0.0,0.0,1.0,0.0,16.25)"><text id="ProcessOnText1149" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="13.325">当传入的value=nil,也依次执行以下流程，只是没有找到的情</text><text id="ProcessOnText1150" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="29.575">况不做处理，若最后找了则清除对象的关联。</text></g></g><g id="ProcessOnG1151"><path id="ProcessOnPath1152" d="M461.5 388.5L530.75 388.5L530.75 388.5L584.7639320225002 388.5" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1153)"/></g><g id="ProcessOnG1155" transform="matrix(1.0,0.0,0.0,1.0,608.5,124.0)" opacity="1.0"><path id="ProcessOnPath1156" d="M0.0 0.0L345.0 0.0L345.0 65.0L0.0 65.0Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1157" transform="matrix(1.0,0.0,0.0,1.0,0.0,16.25)"><text id="ProcessOnText1158" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="13.325">manager对象初始化，spinlock为了保证多线程操作的安全</text><text id="ProcessOnText1159" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="start" font-size="13" x="0.0" y="29.575">。获取associationHashMap对象</text></g></g><g id="ProcessOnG1160"><path id="ProcessOnPath1161" d="M495.0 153.5L548.5 153.5L548.5 153.5L586.7639320225002 153.5" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1162)"/></g><g id="ProcessOnG1164" transform="matrix(1.0,0.0,0.0,1.0,852.0,148.0)" opacity="1.0"><path id="ProcessOnPath1165" d="M0.0 104.0C0.0 -34.666666666666664 328.0 -34.666666666666664 328.0 104.0C328.0 242.66666666666666 0.0 242.66666666666666 0.0 104.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/></g><g id="ProcessOnG1166" transform="matrix(1.0,0.0,0.0,1.0,914.9375,190.0)" opacity="1.0"><path id="ProcessOnPath1167" d="M0.0 62.0C0.0 -20.666666666666668 202.125 -20.666666666666668 202.125 62.0C202.125 144.66666666666666 0.0 144.66666666666666 0.0 62.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/></g><g id="ProcessOnG1168" transform="matrix(1.0,0.0,0.0,1.0,948.5,247.5)" opacity="1.0"><path id="ProcessOnPath1169" d="M0.0 21.25C0.0 -7.083333333333333 144.5 -7.083333333333333 144.5 21.25C144.5 49.583333333333336 0.0 49.583333333333336 0.0 21.25Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1170" transform="matrix(1.0,0.0,0.0,1.0,10.0,13.125)"><text id="ProcessOnText1171" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="62.25" y="13.325">ObjcAssociation</text></g></g><g id="ProcessOnG1172" transform="matrix(1.0,0.0,0.0,1.0,923.0,152.5)" opacity="1.0"><path id="ProcessOnPath1173" d="M0.0 0.0L199.0 0.0L199.0 28.5L0.0 28.5Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1174" transform="matrix(1.0,0.0,0.0,1.0,0.0,6.125)"><text id="ProcessOnText1175" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="99.5" y="13.325">AssociationsHashMap</text></g></g><g id="ProcessOnG1176" transform="matrix(1.0,0.0,0.0,1.0,923.0,214.5)" opacity="1.0"><path id="ProcessOnPath1177" d="M0.0 0.0L199.0 0.0L199.0 28.5L0.0 28.5Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1178" transform="matrix(1.0,0.0,0.0,1.0,0.0,6.125)"><text id="ProcessOnText1179" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="99.5" y="13.325">ObjectAssociationMap</text></g></g><g id="ProcessOnG1180" transform="matrix(1.0,0.0,0.0,1.0,918.0625,89.5)" opacity="1.0"><path id="ProcessOnPath1181" d="M0.0 0.0L199.0 0.0L199.0 28.5L0.0 28.5Z" stroke="#323232" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1182" transform="matrix(1.0,0.0,0.0,1.0,0.0,6.125)"><text id="ProcessOnText1183" fill="#000000" font-weight="normal" font-style="normal" text-decoration="blink" font-family="微软雅黑" text-anchor="middle" font-size="13" x="99.5" y="13.325">存储结构示意图</text></g></g></g></g></svg>



#####名词解释：

* AssociationsManager 类似于一个单例对象，保存着整个系统的关联对象数据。包含有一个多线程操作的锁和AssociationsHashMap的表。
* AssociationsHashMap 保存的对象的地址（一个类对象）和这个类全部关联的对象的hash table.
* ObjectAssociationMap 一个类全部关联的对象，key为索引。
* ObjcAssociation 保存的最小结构单元数据，要关联的value，和关联策略。
* `ObjectAssociationMap::iterator j = refs->find(key);` c++中的迭代操作，遍历对象中的key-value.
* `old_association = j->second;` 获取j对象的第二个数据，也就是`ObjcAssociation`对象。


###总结
以上皆为runtime关联对象如何保存的分析总结，可能有理解的不到位的地方，还在研究中。



